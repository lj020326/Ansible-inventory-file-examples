---

- name: "Define derived ntp_client"
  hosts: localhost
  gather_facts: false
  connection: local
  tasks:

    - name: Derive __ntp_client list of hosts based on difference of network_internal and ntp_server groups
      set_fact:
        __ntp_client: "{{ groups['network_internal'] | difference(groups['ntp_server']) }}"

    - debug:
        var: groups['network_internal']

    - debug:
        var: groups['ntp_server']

    - debug:
        var: __ntp_client

    - name: "Copy __ntp_client fact to other servers"
      set_fact:
        __ntp_client: "{{ __ntp_client }}"
      delegate_to: "{{ item }}"
      delegate_facts: True
      with_items: "{{ groups['all'] }}"
      when: item != "localhost"

- name: "Apply ntp_client group setting to machines in the derived list"
  hosts: network_internal
  gather_facts: false
  connection: local
  tasks:

    - debug:
        var: __ntp_client

    - name: Derive ntp_client child group of hosts based on difference of network_internal and ntp_server
      when: inventory_hostname in __ntp_client
      group_by:
        key: "ntp_client"
        parents: ['ntp','network_internal']

- name: "Run trace var play for machines in the newly defined ntp_client group"
  hosts: ntp_client
  gather_facts: false
  connection: local
  tasks:

    - debug:
        var: trace_var
    - debug:
        var: group_trace_var
    - debug:
        var: group_names
    - debug:
        var: foreman.ip
    - debug:
        var: ntp_servers

